# Настройка Telegram Stars для платежей

## Шаг 1: Настройка бота в BotFather

Для работы с Telegram Stars необходимо настроить бота в BotFather:

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота
4. Выберите "Payments"
5. Выберите "Telegram Stars"
6. Следуйте инструкциям для активации

## Шаг 2: Проверка переменных окружения

Убедитесь, что в `.env` файле установлены следующие переменные:

```bash
# Включить/выключить систему платежей (по умолчанию: true)
PAYMENT_ENABLED=true

# ID администраторов через запятую (необязательно)
ADMIN_USER_IDS=123456789,987654321

# Количество кредитов в пакете (по умолчанию: 10)
STARS_PACKAGE_CREDITS=10

# Цена пакета в Stars (по умолчанию: 500)
STARS_PACKAGE_PRICE=500

# URL базы данных PostgreSQL (обязательно)
DATABASE_URL=postgresql://...
```

## Шаг 3: Выполнение миграции БД

Убедитесь, что таблицы платежей созданы:

```bash
npm run migrate-payments
```

Проверка таблиц:

```bash
npx ts-node scripts/check-payments-tables.ts
```

## Шаг 4: Перезапуск бота

После настройки BotFather и выполнения миграции перезапустите бота:

```bash
pm2 restart video-bot --update-env
```

## Проверка работы

1. Откройте бота на втором аккаунте (не администраторском)
2. Попробуйте использовать команду `/translate` или озвучку
3. Если кредитов нет, должно появиться сообщение с предложением купить кредиты

## Отладка

Если платежи не работают:

1. Проверьте логи бота на наличие ошибок:
   ```bash
   pm2 logs video-bot
   ```

2. Проверьте, что `PAYMENT_ENABLED=true` в `.env`

3. Проверьте, что таблицы платежей созданы:
   ```bash
   npx ts-node scripts/check-payments-tables.ts
   ```

4. Убедитесь, что бот настроен в BotFather для работы с Stars

5. Проверьте, что пользователь не в списке администраторов (`ADMIN_USER_IDS`)

## Важно

- **Бесплатный кредит**: Каждый пользователь получает 1 бесплатный кредит при первом использовании
- **Администраторы**: Пользователи из `ADMIN_USER_IDS` имеют неограниченные кредиты
- **Отключение платежей**: Если `PAYMENT_ENABLED=false`, все функции доступны без ограничений

