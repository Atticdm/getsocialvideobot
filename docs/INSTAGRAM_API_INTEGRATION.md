# Работа через Instagram API

## Обзор

Instagram предоставляет официальный API для доступа к контенту, но с существенными ограничениями. Рассмотрим варианты и их применимость для скачивания Reels.

## Варианты Instagram API

### 1. Instagram Graph API (Meta)

**Что это:**
- Официальный API от Meta (Facebook) для работы с Instagram контентом
- Часть платформы Facebook Graph API
- Требует создания Facebook App и прохождения процесса ревью

**Возможности:**
- ✅ Получение метаданных постов и Reels
- ✅ Доступ к медиа-файлам (изображения, видео)
- ✅ Работа с бизнес-аккаунтами и Creator аккаунтами
- ✅ Официальная поддержка от Meta

**Ограничения:**
- ❌ **Работает только с бизнес/Creator аккаунтами** (не с личными)
- ❌ **Можно получать только свой контент** или контент аккаунтов, которые дали разрешение
- ❌ **Нельзя скачивать произвольные публичные Reels** без разрешения владельца
- ❌ Требует сложной настройки и ревью от Meta
- ❌ Rate limits (ограничения на количество запросов)
- ❌ Требует Facebook Business Account

**Процесс настройки:**
1. Создать Facebook App на https://developers.facebook.com
2. Добавить Instagram Basic Display или Instagram Graph API продукт
3. Пройти процесс ревью (может занять недели)
4. Получить Access Token
5. Связать Instagram бизнес-аккаунт с Facebook Page

**Пример запроса:**
```bash
# Получить информацию о Reel (только если это ваш контент или есть разрешение)
GET https://graph.instagram.com/{reel-id}?fields=id,caption,media_type,media_url,thumbnail_url,timestamp&access_token={access-token}
```

**Проблема для нашего случая:**
Instagram Graph API **не подходит** для скачивания произвольных публичных Reels, потому что:
- Можно получать только свой контент
- Нужно разрешение владельца контента
- Не работает с обычными личными аккаунтами

---

### 2. Instagram Basic Display API

**Что это:**
- Упрощенный API для базового доступа к Instagram данным
- Предназначен для чтения собственного контента пользователя

**Ограничения:**
- ❌ Работает только с собственным контентом пользователя
- ❌ Нельзя получать произвольные публичные Reels
- ❌ Очень ограниченный функционал
- ❌ Требует OAuth авторизации пользователя

**Вывод:** Не подходит для нашей задачи.

---

### 3. Неофициальные API / Web Scraping

**Текущий подход (yt-dlp + cookies):**
- ✅ Работает с любыми публичными Reels
- ✅ Не требует ревью от Meta
- ✅ Простая настройка (только cookies)
- ✅ Поддерживает все типы контента
- ⚠️ Использует неофициальный метод (scraping)
- ⚠️ Может нарушать Terms of Service Instagram
- ⚠️ Требует обновления cookies периодически

**Альтернативы:**
- Instagram Private API (неофициальные библиотеки)
- Web scraping через Playwright/Puppeteer
- Использование прокси и ротация User-Agents

---

## Сравнение подходов

| Критерий | Instagram Graph API | yt-dlp + Cookies (текущий) |
|----------|---------------------|---------------------------|
| **Доступ к публичным Reels** | ❌ Только свой контент | ✅ Любые публичные |
| **Простота настройки** | ❌ Сложно (ревью, бизнес-аккаунт) | ✅ Просто (только cookies) |
| **Официальная поддержка** | ✅ Да | ❌ Нет |
| **Стабильность** | ✅ Высокая | ⚠️ Зависит от изменений Instagram |
| **Rate limits** | ⚠️ Есть ограничения | ⚠️ Есть ограничения |
| **Стоимость** | ✅ Бесплатно | ✅ Бесплатно |
| **Время настройки** | ❌ Недели (ревью) | ✅ Минуты |
| **Поддержка личных аккаунтов** | ❌ Нет | ✅ Да |

---

## Можно ли использовать Graph API для скачивания?

### Технически возможно, но с ограничениями:

**Сценарий 1: Скачивание своего контента**
```typescript
// Если пользователь авторизуется через OAuth и дает доступ к своему аккаунту
async function downloadOwnReel(reelId: string, accessToken: string) {
  const response = await fetch(
    `https://graph.instagram.com/${reelId}?fields=media_url,thumbnail_url,caption&access_token=${accessToken}`
  );
  const data = await response.json();
  // Скачать video_url
  return downloadVideo(data.media_url);
}
```

**Сценарий 2: Скачивание контента с разрешением**
- Пользователь должен быть владельцем контента
- Или владелец должен дать разрешение через Facebook App

**Проблема:** 
Для бота, который скачивает **произвольные публичные Reels по ссылке**, Graph API **не подходит**, потому что:
1. Нужно разрешение владельца каждого Reel
2. Нельзя просто взять ссылку и скачать
3. Требуется сложная OAuth авторизация для каждого пользователя

---

## Рекомендация для текущего проекта

**Текущий подход (yt-dlp + cookies) оптимален**, потому что:

1. ✅ **Работает с любыми публичными Reels** - главное требование
2. ✅ **Простая настройка** - только cookies
3. ✅ **Быстрый старт** - не нужно ждать ревью
4. ✅ **Гибкость** - работает с любыми типами контента

**Когда стоит рассмотреть Graph API:**
- Если нужно работать только со своим контентом
- Если есть бизнес-аккаунт и нужна официальная интеграция
- Если нужна аналитика и статистика по постам
- Если планируется коммерческое использование с соблюдением всех правил

---

## Альтернативный гибридный подход

Можно комбинировать оба метода:

```typescript
async function downloadInstagramReel(url: string) {
  // 1. Попробовать через Graph API (если есть токен и это свой контент)
  if (hasGraphApiToken && isOwnContent(url)) {
    try {
      return await downloadViaGraphAPI(url);
    } catch (error) {
      logger.warn('Graph API failed, falling back to yt-dlp');
    }
  }
  
  // 2. Fallback на yt-dlp + cookies (для произвольных Reels)
  return await downloadViaYtDlp(url);
}
```

**Преимущества:**
- Использует официальный API когда возможно
- Fallback на yt-dlp для остальных случаев
- Более стабильное решение

**Недостатки:**
- Усложняет код
- Все равно нужны cookies для большинства случаев

---

## Вывод

**Для вашего бота (скачивание произвольных публичных Reels):**

1. **Instagram Graph API не подходит** - можно получать только свой контент
2. **yt-dlp + cookies - оптимальное решение** - работает с любыми публичными Reels
3. **Альтернативы (scraping, private API)** - более сложные и менее стабильные

**Рекомендация:** Продолжать использовать yt-dlp + cookies, так как это единственный способ скачивать произвольные публичные Reels без разрешения владельца.

---

## Дополнительные ресурсы

- [Instagram Graph API Documentation](https://developers.facebook.com/docs/instagram-api/)
- [Instagram Basic Display API](https://developers.facebook.com/docs/instagram-basic-display-api/)
- [Facebook App Review Process](https://developers.facebook.com/docs/app-review/)
- [yt-dlp Instagram Extractor](https://github.com/yt-dlp/yt-dlp/blob/master/yt_dlp/extractor/instagram.py)

